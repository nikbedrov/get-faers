import pandas as pd
from pprint import pprint
import matplotlib.pyplot as plt
plt.style.use('fivethirtyeight')
plt.rcParams["figure.figsize"] = (4, 3)
import requests
from urllib.parse import quote
# rate limiting is important to avoid accidental service abuse of the OpenFDA API provider
from ratelimit import limits, sleep_and_retry

OPENFDA_API = "https://api.fda.gov/drug/event.json"

@sleep_and_retry
@limits(calls=40, period=60)
def call_api(params):
    """
    OpenFDA API call. Respects rate limit. Overrides default data limit
    Input: dictionary with API parameters {search: '...', count: '...'}
    Output: nested dictionary representation of the JSON results section
    
    OpenFDA API rate limits:
         With no API key: 40 requests per minute, per IP address. 1000 requests per day, per IP address.
         With an API key: 240 requests per minute, per key. 120000 requests per day, per key.
    """
    if not params:
        params = {}
    params['limit'] = params.get('limit', 1000)
    response = requests.get(OPENFDA_API, params=params)

    if response.status_code != 200:
        raise Exception('API response: {}'.format(response.status_code))
    return response.json()['results']


OPENFDA_METADATA_YAML = "https://open.fda.gov/fields/drugevent.yaml"

from munch import Munch

def api_meta():
    """
    YAML file with field description and other metadata retrieved from the OpenFDA website
    Parses YAML file and provides syntactic sugar for accessing nested dictionaries
    Example: .patient.properties.patientagegroup.possible_values.value
    Note: reserved words, such as count and items still have to be accessed via ['count'], ['items']
    """
    response = requests.get(OPENFDA_METADATA_YAML)
    if response.status_code != 200:
        raise Exception('Could not retrieve YAML file with drug event API fields')
    y = Munch.fromYAML(response.text)
    return y['properties']

######### Drug Name ##########
drugname = "NEXLETOL"

#GET AB - all cases for drug
df = pd.DataFrame(call_api({
    "count": "patient.drug.medicinalproduct.exact",
    'search':'patient.drug.medicinalproduct:"{}"'.format(drugname)
    }))

drug_AB = df[df["term"] == drugname]["count"].values[0]

#GET A - all cases for drug + event 
df = pd.DataFrame(call_api({
    "count": "patient.reaction.reactionmeddrapt.exact",
    'search':'patient.drug.medicinalproduct:"{}"'.format(drugname)
    }))

drug_event_AB = df

reactions = df['term'].values
reactions_counts = []

def get_counts_for_reaction(reaction):
    """Returns dataframe with yearly tally of event reports for a given reaction"""
    aes_df = pd.DataFrame(call_api({
            "count": "patient.reaction.reactionmeddrapt.exact",
            'search':'patient.reaction.reactionmeddrapt:"{}"'.format(reaction.replace("^", " ").replace("/", " "))
    }))
 
    for item in aes_df.iterrows():
        if item[1]["term"].lower() == reaction.lower():
            reactions_counts.append([reaction, item[1]["count"]])
            print("Added ", reaction.lower())
    

for reaction in reactions:
    #reaction = reaction.replace("^", " ").replace("/", " ") 
    get_counts_for_reaction(reaction)
    
#reactions_counts = [['ARTHRALGIA', 352719], ['PAIN IN EXTREMITY', 263758], ['MYALGIA', 149069], ['MUSCLE SPASMS', 161488], ['BACK PAIN', 205087], ['HEADACHE', 548976], ['NAUSEA', 683980], ['DRUG INEFFECTIVE', 1147832], ['DIARRHOEA', 546774], ['FATIGUE', 669888], ['DIZZINESS', 435262], ['OFF LABEL USE', 673511], ['GOUT', 15678], ['HEPATIC ENZYME INCREASED', 57296], ['RASH', 365876], ['BLOOD URIC ACID INCREASED', 4956], ['PAIN', 548014], ['ABDOMINAL DISCOMFORT', 143628], ['PRODUCT DOSE OMISSION ISSUE', 183837], ['PRURITUS', 302468], ['TENDON RUPTURE', 11144], ['ABDOMINAL PAIN UPPER', 176577], ['PERIPHERAL SWELLING', 129714], ['BLOOD CHOLESTEROL INCREASED', 40223], ['FEELING ABNORMAL', 217957], ['ASTHENIA', 327878], ['BLOOD CREATININE INCREASED', 58414], ['BLOOD CREATINE PHOSPHOKINASE INCREASED', 26850], ['BLOOD TRIGLYCERIDES INCREASED', 15828], ['GAIT DISTURBANCE', 170876], ['INSOMNIA', 236607], ['LOW DENSITY LIPOPROTEIN INCREASED', 6436], ['NECK PAIN', 48927], ['RHINORRHOEA', 54669], ['ARTHRITIS', 68751], ['DYSPNOEA', 493548], ['MALAISE', 392058], ['MUSCULAR WEAKNESS', 99537], ['VOMITING', 402610], ['BLOOD PRESSURE INCREASED', 134827], ['BLOOD UREA INCREASED', 15377], ['FALL', 289963], ['PARAESTHESIA', 140971], ['ALANINE AMINOTRANSFERASE INCREASED', 54496], ['BLOOD GLUCOSE INCREASED', 169918], ['COUGH', 238528], ['GASTROINTESTINAL DISORDER', 69552], ['HYPERTENSION', 184605], ['INFLUENZA LIKE ILLNESS', 74819], ['ABDOMINAL PAIN', 201234], ['ANAEMIA', 168572], ['ASPARTATE AMINOTRANSFERASE INCREASED', 47158], ['ATRIAL FIBRILLATION', 85571], ['BURNING SENSATION', 62182], ['CHEST PAIN', 165331], ['CONSTIPATION', 180548], ['DEATH', 747976], ['FLATULENCE', 48632], ['HYPOAESTHESIA', 132139], ['INAPPROPRIATE SCHEDULE OF PRODUCT ADMINISTRATION', 128252], ['OEDEMA PERIPHERAL', 111086], ['ROTATOR CUFF SYNDROME', 11537], ['TENDON DISORDER', 5827], ['TENDON PAIN', 6767], ['THERAPEUTIC RESPONSE UNEXPECTED', 40453], ['WEIGHT DECREASED', 243588], ['ADVERSE DRUG REACTION', 72759], ['ALOPECIA', 174525], ['BLOOD PRESSURE DECREASED', 58141], ['BRONCHITIS', 66678], ['DRUG DOSE OMISSION BY DEVICE', 49205], ['ERYTHEMA', 179139], ['JOINT SWELLING', 103037], ['MOBILITY DECREASED', 61670], ['NEUROPATHY PERIPHERAL', 78639], ['OROPHARYNGEAL PAIN', 80432], ['PALPITATIONS', 102399], ['PANCREATITIS', 46489], ['PRODUCT USE IN UNAPPROVED INDICATION', 187105], ['PRODUCT USE ISSUE', 155065], ['THERAPY INTERRUPTED', 44995], ['URTICARIA', 139717], ['WRONG TECHNIQUE IN PRODUCT USAGE PROCESS', 169717], ['ACUTE KIDNEY INJURY', 128474], ['BALANCE DISORDER', 77145], ['CONTUSION', 83267], ['COVID-19', 150251], ['DEHYDRATION', 117816], ['DEVICE DIFFICULT TO USE', 51812], ['DISTURBANCE IN ATTENTION', 48938], ['DRUG EFFECT LESS THAN EXPECTED', 7442], ['DRUG INTERACTION', 140228], ['GAIT INABILITY', 25648], ['GASTROOESOPHAGEAL REFLUX DISEASE', 68813], ['GLOMERULAR FILTRATION RATE DECREASED', 9654], ['HEPATIC STEATOSIS', 16118], ['HIGH DENSITY LIPOPROTEIN DECREASED', 3021], ['HYPERURICAEMIA', 3562], ['HYPOTENSION', 175490], ['INFLAMMATION', 42564], ['JOINT NOISE', 1546], ['JOINT STIFFNESS', 22976], ['LIGAMENT SPRAIN', 8430], ['LIVER FUNCTION TEST INCREASED', 16824], ['MOVEMENT DISORDER', 28743], ['MUSCLE RUPTURE', 3339], ['PAIN IN JAW', 25499], ['PRODUCT PHYSICAL ISSUE', 16367], ['PYREXIA', 303334], ['RENAL IMPAIRMENT', 71583], ['SWELLING', 80444], ['SWOLLEN TONGUE', 27829], ['TENDERNESS', 9398], ['THERAPY CESSATION', 43288], ['VISION BLURRED', 117578], ['VISUAL IMPAIRMENT', 103614], ['AMNESIA', 58715], ['ANXIETY', 254161], ['ARTHROPATHY', 48932], ['BILIARY COLIC', 2333], ['BLOOD CHOLESTEROL ABNORMAL', 4040], ['BLOOD TEST ABNORMAL', 11931], ['BLOOD THYROID STIMULATING HORMONE INCREASED', 8191], ['BONE PAIN', 51713], ['CHEST DISCOMFORT', 87241], ['CHRONIC KIDNEY DISEASE', 71553], ['CONFUSIONAL STATE', 142817], ['CYTOPENIA', 8942], ['DERMATITIS', 16499], ['DISABILITY', 17171], ['DISEASE PROGRESSION', 100188], ['DRY MOUTH', 69535], ['DYSGEUSIA', 68277], ['DYSPEPSIA', 83882], ['EYE PAIN', 44347], ['EYE SWELLING', 31709], ['HAEMATOMA', 23520], ['HAEMOGLOBIN DECREASED', 91755], ['HYPERSENSITIVITY', 161621], ['IMPAIRED WORK ABILITY', 19425], ['INFECTION', 121556], ['INJECTION SITE PAIN', 246275], ['IRRITABILITY', 54231], ['LABORATORY TEST ABNORMAL', 25745], ['LETHARGY', 51079], ['LIGAMENT RUPTURE', 3924], ['LIP SWELLING', 29057], ['MENISCUS INJURY', 5413], ['MUSCLE DISORDER', 7388], ['MUSCLE TIGHTNESS', 14431], ['NASOPHARYNGITIS', 156853], ['NEOPLASM SKIN', 1362], ['NEPHROLITHIASIS', 38740], ['NEPHROTIC SYNDROME', 5903], ['NEURALGIA', 20762], ['POLLAKIURIA', 36295], ['PRODUCT LEAKAGE', 3743], ['PRODUCT ODOUR ABNORMAL', 8456], ['PRODUCT STORAGE ERROR', 62179], ['PROSTATITIS', 2728], ['PSORIASIS', 115782], ['RENAL DISORDER', 41093], ['RHABDOMYOLYSIS', 36343], ['RHINITIS', 6921], ['SINUSITIS', 89566], ['SKIN DISCOLOURATION', 40360], ['SLEEP DISORDER', 58713], ['SNEEZING', 19032], ['SOMNOLENCE', 175902], ['TACHYCARDIA', 77536], ['TENDON INJURY', 3379], ['THROAT TIGHTNESS', 23643], ['TINNITUS', 40323], ['TOOTH INFECTION', 11482], ['TREMOR', 147938], ['UPPER RESPIRATORY TRACT INFECTION', 39772], ['WEIGHT BEARING DIFFICULTY', 2414], ['WHEEZING', 48287], ['ABDOMINAL DISTENSION', 88826], ['ABNORMAL DREAMS', 25472], ['ACNE PUSTULAR', 711], ['ADVERSE EVENT', 80650], ['AGGRESSION', 45095], ['ALLERGIC REACTION TO EXCIPIENT', 1532], ['AMYLASE INCREASED', 3123], ['ANGER', 30813], ['ANGIOEDEMA', 38274], ['ARTERIAL DISORDER', 1750], ['ARTERIAL OCCLUSIVE DISEASE', 7083], ['ARTERIOSCLEROSIS CORONARY ARTERY', 5841], ['ASTHMA', 89246], ['BACK DISORDER', 14358], ['BLEPHAROSPASM', 4500], ['BLINDNESS', 34765], ['BLINDNESS TRANSIENT', 6381], ['BLOOD BILIRUBIN ABNORMAL', 1061], ['BLOOD PRESSURE FLUCTUATION', 21681], ['BLOOD URINE PRESENT', 17023], ['BODY TEMPERATURE INCREASED', 18494], ['BRAIN FOG', 5290], ['BREAST CANCER', 89103], ['BURSITIS', 9445], ['CARDIAC DISORDER', 84314], ['CARDIAC FLUTTER', 5627], ['CARDIAC OPERATION', 7110], ['CARDIOVASCULAR DISORDER', 23874], ['CARPAL TUNNEL DECOMPRESSION', 893], ['CARPAL TUNNEL SYNDROME', 12323], ['CELLULITIS GANGRENOUS', 183], ['CEREBROSPINAL FLUID LEAKAGE', 1553], ['CEREBROVASCULAR ACCIDENT', 153526], ['CHOKING', 16679], ['CHOLELITHIASIS', 28728], ['CHROMATURIA', 20072], ['CHRONIC OBSTRUCTIVE PULMONARY DISEASE', 45537], ['CIRCUMSTANCE OR INFORMATION CAPABLE OF LEADING TO MEDICATION ERROR', 27211], ['COGNITIVE DISORDER', 40384], ['COLITIS', 30768], ['CORNEAL OEDEMA', 1983], ['CREPITATIONS', 2765], ['DEAFNESS UNILATERAL', 4764], ['DECREASED ACTIVITY', 9128], ['DECREASED APPETITE', 197062], ['DEEP VEIN THROMBOSIS', 59890], ['DERMATITIS ATOPIC', 19518], ['DEVICE ISSUE', 68869], ['DEVICE USE ERROR', 28333], ['DISCOMFORT', 49537], ['DISEASE RECURRENCE', 40698], ['DISORIENTATION', 35903], ['DIZZINESS POSTURAL', 7811], ['DRUG HYPERSENSITIVITY', 174188], ['DRY EYE', 36644], ['DUODENAL ULCER', 6205], ['DYSARTHRIA', 33387], ['DYSKINESIA', 35729], ['DYSPHAGIA', 81730], ['DYSPHEMIA', 3921], ['DYSPHONIA', 50685], ['DYSSTASIA', 26216], ['ENANTHEMA', 494], ['EPIGASTRIC DISCOMFORT', 3481], ['EPISTAXIS', 65992], ['EYE HAEMORRHAGE', 11992], ['EYE IRRITATION', 42894], ['EYE MOVEMENT DISORDER', 6038], ['EYELID RASH', 670], ['FEELING HOT', 54464], ['FLUID INTAKE REDUCED', 4133], ['FOOT DEFORMITY', 9605], ['FOOT FRACTURE', 16873], ['GASTRIC DISORDER', 34583], ['GASTRIC INFECTION', 3310], ['GASTRIC POLYPS', 1969], ['GASTRITIS', 23171], ['GASTROINTESTINAL HYPOMOTILITY', 1276], ['GASTROINTESTINAL INFECTION', 7558], ['GASTROINTESTINAL PAIN', 9235], ['GENERAL PHYSICAL CONDITION ABNORMAL', 5971], ['GENERAL PHYSICAL HEALTH DETERIORATION', 93366], ['GROIN PAIN', 7836], ['HAEMATOCRIT DECREASED', 18301], ['HAEMATURIA', 30917], ['HAEMORRHAGE', 89317], ['HAEMORRHAGE URINARY TRACT', 2259], ['HANGOVER', 3212], ['HEAD INJURY', 27282], ['HEPATIC LESION', 3700], ['HEPATITIS C', 11611], ['HERPES SIMPLEX', 5482], ['HIP ARTHROPLASTY', 12484], ['HOT FLUSH', 61428], ['HUMERUS FRACTURE', 4317], ['HUNGER', 9652], ['HYPERAESTHESIA', 7643], ['HYPERCHOLESTEROLAEMIA', 7379], ['HYPERHIDROSIS', 114943], ['HYPERVIGILANCE', 856], ['HYPOAESTHESIA ORAL', 13315], ['ILL-DEFINED DISORDER', 52554], ['IMPAIRED QUALITY OF LIFE', 11304], ['INABILITY TO AFFORD MEDICATION', 7160], ['INDURATION', 1611], ['INFLUENZA', 91876], ['INFUSION RELATED REACTION', 53825], ['INFUSION SITE ERYTHEMA', 6199], ['INFUSION SITE IRRITATION', 936], ['INFUSION SITE PRURITUS', 2285], ['INFUSION SITE URTICARIA', 487], ['INJURY', 64702], ['INTENTIONAL PRODUCT MISUSE', 75581], ['INTERVERTEBRAL DISC DEGENERATION', 8556], ['INTERVERTEBRAL DISC DISORDER', 3899], ['IRRITABLE BOWEL SYNDROME', 17269], ['JOINT INJURY', 18661], ['KIDNEY INFECTION', 17051], ['KNEE ARTHROPLASTY', 16923], ['LACRIMATION INCREASED', 24526], ['LIGAMENT LAXITY', 143], ['LIMB DISCOMFORT', 27194], ['LIPASE INCREASED', 6738], ['LIVER DISORDER', 38109], ['LIVER OPERATION', 231], ['LOSS OF CONSCIOUSNESS', 113030], ['LOWER RESPIRATORY TRACT INFECTION', 36577], ['LUMBAR SPINAL STENOSIS', 2645], ['LUPUS-LIKE SYNDROME', 7500], ['LYMPHOEDEMA', 5885], ['MACULAR DEGENERATION', 10135], ['MEMORY IMPAIRMENT', 121428], ['MICTURITION URGENCY', 9722], ['MIDDLE INSOMNIA', 15930], ['MIGRAINE', 80286], ['MONOPLEGIA', 3872], ['MULTIPLE SCLEROSIS', 43194], ['MUSCLE INJURY', 5693], ['MUSCULOSKELETAL CHEST PAIN', 13541], ['MUSCULOSKELETAL DISCOMFORT', 15014], ['MUSCULOSKELETAL STIFFNESS', 77061], ['MYOCARDIAL INFARCTION', 164415], ['NAIL DISORDER', 6892], ['NASAL CRUSTING', 506], ['NASAL DISCOMFORT', 7157], ['NERVOUSNESS', 48298], ['NIGHT SWEATS', 27015], ['NO ADVERSE EVENT', 137112], ['OCULAR DISCOMFORT', 8109], ['OESOPHAGEAL IRRITATION', 493], ['OESOPHAGEAL SPASM', 1655], ['ORAL DISCOMFORT', 12364], ['ORAL HERPES', 16306], ['ORAL MUCOSAL ERUPTION', 1314], ['OROPHARYNGEAL DISCOMFORT', 6844], ['PANCREATIC DISORDER', 4056], ['PANIC ATTACK', 32109], ['PARANASAL SINUS HYPERSECRETION', 3551], ['PERIPHERAL ARTERY OCCLUSION', 1185], ['PERIPHERAL COLDNESS', 12143], ['PERIPHERAL VENOUS DISEASE', 2405], ['PHARYNGEAL SWELLING', 7165], ['PLATELET COUNT INCREASED', 11497], ['PNEUMONIA', 275683], ['POOR QUALITY PRODUCT ADMINISTERED', 6893], ['POOR QUALITY SLEEP', 18173], ['PRESCRIBED UNDERDOSE', 16907], ['PRODUCT COMPLAINT', 18595], ['PRODUCT DISPENSING ISSUE', 1509], ['PRODUCT DOSE OMISSION IN ERROR', 14667], ['PRODUCT IMPURITY', 222], ['PRODUCT PRESCRIBING ISSUE', 11011], ['PRODUCT SOLUBILITY ABNORMAL', 4174], ['PRODUCT TASTE ABNORMAL', 11433], ['PRODUCT USE COMPLAINT', 10928], ['PROTEIN URINE PRESENT', 4340], ['PSORIATIC ARTHROPATHY', 31363], ['PSYCHOMOTOR HYPERACTIVITY', 15195], ['PUNCTATE KERATITIS', 735], ['RASH ERYTHEMATOUS', 37060], ['RASH MACULAR', 29338], ['RASH PRURITIC', 45535], ['READING DISORDER', 2040], ['RESTLESS LEGS SYNDROME', 16238], ['RETINAL TEAR', 2070], ['RHEUMATOID ARTHRITIS', 97191], ['RHINALGIA', 2185], ['ROSACEA', 3915], ['SEASONAL ALLERGY', 11387], ['SECRETION DISCHARGE', 9951], ['SENSORY DISTURBANCE', 14799], ['SERUM FERRITIN INCREASED', 4558], ['SHOULDER OPERATION', 3240], ['SINUS CONGESTION', 11864], ['SINUS DISORDER', 17245], ['SINUS OPERATION', 1998], ['SKELETAL INJURY', 10031], ['SKIN REACTION', 12016], ['SKIN SWELLING', 6285], ['SLUGGISHNESS', 8984], ['SPINAL CORD OPERATION', 157], ['SPONDYLITIS', 2995], ['STRESS', 61642], ['SYNOVIAL CYST', 4213], ['SYSTEMIC LUPUS ERYTHEMATOSUS', 27189], ['TASTE DISORDER', 14469], ['TEMPOROMANDIBULAR JOINT SYNDROME', 2708], ['TENDONITIS', 14072], ['THERAPEUTIC PRODUCT EFFECT DECREASED', 35600], ['THERAPEUTIC PRODUCT EFFECT INCOMPLETE', 57553], ['THERAPEUTIC RESPONSE DECREASED', 51082], ['THERAPY CHANGE', 7228], ['THERAPY NON-RESPONDER', 34481], ['THERMAL BURN', 6375], ['THROAT IRRITATION', 38206], ['TOOTHACHE', 15829], ['TRANSAMINASES INCREASED', 19553], ['TREATMENT NONCOMPLIANCE', 44284], ['UPPER LIMB FRACTURE', 18036], ['URINARY INCONTINENCE', 26197], ['URINARY TRACT INFECTION', 145705], ['URINE ABNORMALITY', 3804], ['VAGINAL INFECTION', 4066], ['VASCULAR GRAFT', 2617], ['VEIN DISORDER', 4574], ['VITREOUS FLOATERS', 8039], ['WOUND SECRETION', 3572]]
drug_AC = dict(reactions_counts)

faers_all_cases = 29153222


aedata = {}

stats_df = pd.DataFrame(columns=["Drug Name", "PT Name", "A", "AB", "AC", "ABCD"])

for index, drugevent in enumerate(drug_event_AB.values):
    ac_count = drug_AC.get(drugevent[0]) 
    row = (drugname, drugevent[0], drugevent[1], drug_AB, ac_count, faers_all_cases )
    stats_df.loc[index] = row

stats_df.to_csv("FAERS_Nelxetol_1.csv", index=False)




print("debug")